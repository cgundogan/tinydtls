# Makefile for tinydtls
#
# Copyright (c) 2011, 2012, 2013, 2014, 2015 Olaf Bergmann (TZI) and others.
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Eclipse Public License v1.0
# and Eclipse Distribution License v. 1.0 which accompanies this distribution.
#
# The Eclipse Public License is available at http://www.eclipse.org/legal/epl-v10.html
# and the Eclipse Distribution License is available at 
# http://www.eclipse.org/org/documents/edl-v10.php.
#
# Contributors:
#    Olaf Bergmann  - initial API and implementation
#    Hauke Mehrtens - memory optimization, ECC integration
#

# the library's version
VERSION:=@PACKAGE_VERSION@

# tools
@SET_MAKE@
SHELL = /bin/sh
MKDIR = mkdir

abs_builddir = @abs_builddir@
top_builddir = @top_builddir@
top_srcdir:= @top_srcdir@


ECC_SOURCES:= ecc.c uECC.c test/test_compute.c test/test_ecdh.c test/test_compress.c test/test_ecdsa.c
ECC_HEADERS:= ecc.h uECC.h types.h uECC_vli.h platform-specific.inc curve-specific.inc \
                asm_arm.inc asm_arm_mult_square.inc asm_arm_mult_square_umaal.inc \
                asm_avr.inc asm_avr_mult_square.inc

FILES:=Makefile.in Makefile.contiki $(ECC_SOURCES) $(ECC_HEADERS)
DISTDIR=$(top_builddir)/@PACKAGE_TARNAME@-@PACKAGE_VERSION@

ifeq ("@WITH_CONTIKI@", "1")
include Makefile.contiki
else
ECC_OBJECTS:= $(patsubst %.c, %.o, $(ECC_SOURCES))
PROGRAMS:= test_compress test_compute test_ecdh test_ecdsa
CPPFLAGS=@CPPFLAGS@
CFLAGS=-Wall -std=c99 @CFLAGS@ -DTEST_INCLUDE
LDLIBS=@LIBS@

.PHONY: all dirs clean install distclean .gitignore doc

.SUFFIXES:
.SUFFIXES:      .c .o

all: $(PROGRAMS)

$(PROGRAMS):: uECC.o
	$(CC) $(CFLAGS) $(CPPFLAGS) -I./ $^ test/$(@F).c -o $(@F)

uECC.o: uECC.c uECC.h *.inc
	$(CC) $(CFLAGS) $(CPPFLAGS) -c uECC.c -o uECC.o

check:	
	echo DISTDIR: $(DISTDIR)
	echo top_builddir: $(top_builddir)

clean:
	@rm -f $(PROGRAMS) *.o $(LIB) $(OBJECTS)
	for dir in $(SUBDIRS); do \
		$(MAKE) -C $$dir clean ; \
	done

distclean:	clean
	@rm -rf $(DISTDIR)
	@rm -f *~ $(DISTDIR).tar.gz
endif # WITH_CONTIKI

dist:	$(FILES)
	test -d $(DISTDIR)/ecc || mkdir $(DISTDIR)/ecc
	cp -p $(FILES) $(DISTDIR)/ecc

install:	$(ECC_HEADERS)
	test -d $(includedir)/ecc || mkdir -p $(includedir)/ecc
	$(install) $(ECC_HEADERS) $(includedir)/ecc

.gitignore:
	echo "core\n*~\n*.[oa]\n*.gz\n*.cap\n$(PROGRAM)\n$(DISTDIR)\n.gitignore" >$@
